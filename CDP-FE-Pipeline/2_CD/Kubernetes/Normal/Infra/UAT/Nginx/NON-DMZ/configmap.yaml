apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-conf-cm
  namespace: deploy-uat
data:
  nginx.conf: |
    user nginx;
    worker_processes  1;
    error_log  /dev/stdout;
    events {
      worker_connections  10240;
    }
    http {

      log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';
      access_log  /var/log/nginx/access.log  main;
      #access_log  /dev/stdout;
      server {

        listen 443 ssl;

        ssl_certificate /etc/ssl/uatdigicorp.crt;
        ssl_certificate_key /etc/ssl/uatdigicorp.key;

        server_name uatdigicorp.axisb.com;
        client_max_body_size 50M;

        # Disable server_tokens Directive
        server_tokens off;

        # security HSTS #
        add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";

        # Disable SSL 3 and keep only TLS #
        #ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_protocols TLSv1.2 TLSv1.3;

        # Disable weak cipher suites #
        ssl_ciphers "EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA HIGH !RC4 !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS";

        # Disable unwanted HTTP methods #
        if ($request_method !~ ^(GET|HEAD|POST)$ )
        {
         return 405;
        }

        # Deny http_user_agent - case insensitive matching #
        if ($http_user_agent ~* (netcrawl|npbot|malicious|bot|backdoor|crawler|bandit)) {
            return 403;
        }

        # Security Headers #
        add_header X-XSS-Protection "1; mode=block";      # X-XSS Protection
        add_header X-Frame-Options "SAMEORIGIN";          # Clickjacking Attack
        add_header X-Content-Type-Options nosniff;        # Browser Sniffing Protection  

        # Implement HTTPOnly and Secure Cookie #
        proxy_cookie_path / "/; HTTPOnly; Secure";


        # Httpoxy vulnerability #
        #proxy_set_header Proxy "";

        # Request URL overwrite #
        #proxy_set_header X-Original-URL "";
        #proxy_set_header X-Rewrite-URL "";

        # Prevent Information leaks #
        #proxy_hide_header X-Powered-By;
        #proxy_hide_header Server;
        #proxy_hide_header X-AspNetMvc-Version;
        #proxy_hide_header X-AspNet-Version;
        #
        #proxy_set_header clientIPAddress "";
        #proxy_set_header x-forwarded-for "";
        #proxy_set_header client-ip "";
        #proxy_set_header forwarded "";
        #proxy_set_header from  "";
        #proxy_set_header referer "";
        #proxy_set_header x-client-ip "";
        #proxy_set_header x-originating-ip "";
        #proxy_set_header x-wap-profile "";

        # Set Buffer Size Limitations #
        client_body_buffer_size 1K;
        client_header_buffer_size 16k;
        large_client_header_buffers 4 16k;

       #access_log /dev/stdout;
       #error_log /dev/stdout;
        location / {
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header Host $http_host;
          proxy_set_header X-Real-IP  $proxy_protocol_addr;
          #proxy_set_header X-Forwarded-For $proxy_protocol_addr;
          proxy_redirect off;
          proxy_pass http://frontend-app:34160;
        }

        location ~* \.(jpg|png|gif|jpe?g)$ {
          valid_referers none blocked uatdigicorp.axisb.com www.uatdigicorp.axisb.com;
          if ($invalid_referer) {
            return 403;
        }
        }
      }

    }
